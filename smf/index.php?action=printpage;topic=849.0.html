<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
		<title>Print Page - Fetchmail and You</title>
		<style type="text/css">
			body
			{
				color: black;
				background-color: white;
			}
			body, td, .normaltext
			{
				font-family: Verdana, arial, helvetica, serif;
				font-size: small;
			}
			*, a:link, a:visited, a:hover, a:active
			{
				color: black !important;
			}
			table
			{
				empty-cells: show;
			}
			.code
			{
				font-size: x-small;
				font-family: monospace;
				border: 1px solid black;
				margin: 1px;
				padding: 1px;
			}
			.quote
			{
				font-size: x-small;
				border: 1px solid black;
				margin: 1px;
				padding: 1px;
			}
			.smalltext, .quoteheader, .codeheader
			{
				font-size: x-small;
			}
			.largetext
			{
				font-size: large;
			}
			hr
			{
				height: 1px;
				border: 0;
				color: black;
				background-color: black;
			}
		</style>
	</head>
	<body>
		<h1 class="largetext">Pensacola Linux User's Group</h1>
		<h2 class="normaltext">Club Stuff => Articles => Topic started by: rugmonster on July 06, 2003, 03:15:56 pm</h2>

		<table width="90%" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td>
					<br />
					<hr size="2" width="100%" />
					Title: <b>Fetchmail and You</b><br />
					Post by: <b>rugmonster</b> on <b>July 06, 2003, 03:15:56 pm</b>
					<hr />
					<div style="margin: 0 5ex;"><span style="text-decoration: underline;">Introduction</span><br /><br />I ran into a problem recently at work. The &quot;web nazis&quot; had decided to block access to my ISPs webmail site which I used to check my personal mail. I like having access to my home email, so I decided to look into option I might have to get around this. <br /><br />I had heard of the program fetchmail (http://catb.org/~esr/fetchmail/) being used to retrieve mail from one mail server and delivering it to another. Fetchmail is actually quite versatile as it can be used to retrieve mail from multiple servers and deliver to multiple local or remote accounts. For my purposed however, I only wanted it to retrieve mail from my ISP's POP3 server and deliver it locally so that I could then access it somehow.<br /><br /><br /><span style="text-decoration: underline;">Internet Mail: The Flow</span><br /><br />Email has a specific way it flows on the Internet. There are several different programs that handle the way your message get from point A to point B. The program that you use to read your mail and compose new messages is called a Mail User Agent (MUA). Your MUA retrieves mail from your incoming mail server, which is usually a POP3 or IMAP4, server and allows you to view that mail as well as helps you send mail out to your outgoing mail server, or SMTP server.<br /><br />Now, let's say you compose an email to your brother in Washington state. When you send that message, your MUA sends that message to your SMTP server. That SMTP server is a Message Transfer Agent. Common MTAs are sendmail, exim, postfix as well as many others. The MTA looks at the header you MUA puts on your email message for the destination address, as well as a few other things. <br /><br />Once it figures out where your message needs to go, it opens a connection to the MTA that is supposed to handle the mail from your brother's account. The MTA on his server looks at the message and either accepts the mail if it has that account or rejects it. The MTA serves the role or a Message Delivery Agent (MDA) and delivers the message into his mail spool. It might also send the mail to another MDA, such as procmail, for filtering and then delivery.<br /><br />On Unix systems, typically the mail spool is found in /var/spool/mail/&lt;username&gt;. It is usually a file that has all of the messages for that user listed one after another. Not all systems handle mail spools the same, so don't be surprised if you find something different. <br /><br />One thing must be said about MDAs. This term can be used loosely as it is anything that delivers the mail to a mailbox or aids in the retrieval of the mail from a mailbox. The MDA function doesn't aid in the actual transfer between servers like an MTA, nor does it show the mail to the user like an MUA. The MTA hands the mail to the MDA and the MDA puts the mail in the mail spool for the appropriate user. Yes, most MTAs serve double duty in this area. Often times, another service handles the requests from the MUA for the mail, such as a POP3D or IMAPD. These are also MDAs, but handle another aspect of the mail process. I hope this doesn't confuse you. For simplicity however, most of the time we refer to the SMTP server as an MTA and the POP3 or IMAP server as the MDA. Any other program which aids in the delivery, filtering software such as procmail or retrieval software such as fetchmail, we consider those MDAs as well. I hope we are clear as mud on that.<br /><br />When your brother checks his email, his MUA makes a request to the POP3D or IMAPD on his mail server which delivers the mail that is in his mail spool. IMAP servers are special in that they can also handle mail in other &quot;folders&quot; besides the mail spool, but that is another discussion entirely. When he replies to your email the cycle is repeated and the mail flows like magic.<br /><br /><br /><span style="text-decoration: underline;">Objectives</span><br /><br />Just so we are clear on this, let's define our objectives. I want to get the mail off of my ISP's POP3 server and get it on my own server. I want to be able to access this mail from either a tradition mail client such as Evolution, Mutt or Thunderbird, as well as the web based system Squirrelmail. Let's find out what we need to install to accomplish this.<br /><br /><br /><span style="text-decoration: underline;">Fetchmail</span><br /><br />Fetchmail is what we are going to use to collect the mail from the ISP's server. Fetchmail has to have something to pass the mail off to, such as another program to handle the job of MDA(ex. procmail for filtering), a local MTA or a remote MTA. Basically, fetchmail doesn't handle the actual delivery to the user's mail spool so we need something to do that job.<br /><br />In that case, we need to make sure we have an MTA available on our system. I run Slackware 9.0 and luckily it installs sendmail (http://www.sendmail.org) by default and is setup to handle local delivery just fine. Most distributions either install sendmail or exim. Exim (http://www.exim.org) is easier to configure, but for local delivery, you shouldn't have to worry about very much configuration. My suggestion is to go with whatever is installed. If you have to install something, get something light weight and easy to configure like exim or something other than sendmail. <br /><br />If you wish to do filtering or avoid the headaches of installing and configuring a full blown MTA, you can use something like procmail (http://www.procmail.org) to deliver your mail for you. Procmail is a beast of its own and one needs a good handle of regular expressions to configure it to do filtering properly. There are a lot of sites out there with filtering recipes though and this might be easier than setting up a regular SMTP server.<br /><br /><br /><span style="text-decoration: underline;">Setup of Fetchmail</span><br /><br />You should be able to get fetchmail installed as it is very standard. There should be binary packages for your distribution or the source is available and a good ol' ./configure, make, make install should get you rolling. If you need some weird option, the INSTALL file in the source's root directory is very good. My suggestion is to check if fetchmail is already installed:<br /><br /><div class="codeheader">Code:</div><div class="code">fetchmail --version</div><br />You should get something like this if it is installed:<br /><br /><div class="codeheader">Code:</div><div class="code">This is fetchmail release 6.2.2+SSL+NLS<br />Fallback MDA&#58; &#40;none&#41;<br />Linux valentine 2.4.20 #2 Mon Mar 17 22&#58;02&#58;15 PST 2003 i586 unknown<br />Taking options from command line<br />No mailservers set up -- perhaps /home/daniel/.fetchmailrc is missing?</div><br />When fetchmail is run by a user, it looks in that user's $HOME directory for .fetchmailrc. This is where you store the configuration for the servers you want to retrieve mail from and the associated usernames and passwords. Here is the basic format of a .fetchmailrc:<br /><br /><div class="codeheader">Code:</div><div class="code">poll SERVERNAME protocol PROTOCOL username NAME password PASSWORD</div><br />Makes sense, right? Here is an example:<br /><br /><div class="codeheader">Code:</div><div class="code">poll pop.central.cox.net protocol pop3 username &quot;dgivens4&quot; password &quot;XXXXXX&quot;</div><br />Here is the same thing abbreviated:<br /><br /><div class="codeheader">Code:</div><div class="code">poll pop.central.cox.net proto pop3 user &quot;dgivens4&quot; pass &quot;XXXXXX&quot;</div><br />Say you have multiple servers you want to pull messages from:<br /><br /><div class="codeheader">Code:</div><div class="code">poll pop.central.cox.net proto pop3 user &quot;dgivens4&quot; pass &quot;XXXXXX&quot;<br />poll pop.erec.net proto pop3 user &quot;daniel&quot; pass &quot;XXXXXX&quot;</div><br /><br />With these configurations, you will have the mail retrieved and delivered to the name of the account that you retrieved it from. So what do you do if the account you pulled from has a different username than the one you want it delivered to?<br /><br /><div class="codeheader">Code:</div><div class="code">poll pop.central.cox.net proto pop3 user &quot;dgivens4&quot; pass &quot;XXXXXX&quot; is &quot;daniel&quot;</div><br />Here &quot;daniel&quot; is the account we want the mail to go to. Should we want this to be passed on to another account somewhere else, we would use the complete email address, such as &quot;daniel@elsewhere.net&quot;.<br /><br />There are many more options for your .fetchmailrc. Check out the manpage for fetchmail as there is a section all about the full syntax for .fetchmailrc. Also, as an alternative to editing the .fetchmailrc by hand, if you have Tk and Python installed on your system, you can use fetchmailconf. It is an X based utility to auto-magically create a .fetchmailrc for you. For first time users, I suggest using the Novice mode.<br /><br />Since the .fetchmailrc has usernames and passwords, we need to make sure no one else can read it. Let's change the permissions, shall we?<br /><br /><div class="codeheader">Code:</div><div class="code">chmod 0710 /home/&lt;user&gt;/.fetchmailrc</div><br />This is <b>VERY IMPORTANT</b> because fetchmail will not run if the permissions are not set like I have above.<br /><br /><br /><span style="text-decoration: underline;">Running Fetchmail</span><br /><br />Now that fetchmail knows where and how to pull mail, we need to run it. Before we run it, though, make sure you have your local MTA, such as sendmail or exim, setup and running. Unless you tell fetchmail differently, it will send the mail it retrieves to port 25 on the local system. There are run-time options for sending the mail elsewhere, such as another MDA or a foreign server.<br /><br />Let's test out our configuration. To do this, we want to retrieve the mail, but leave it on the server...just in case:<br /><br /><div class="codeheader">Code:</div><div class="code">fetchmail -ak</div><br />If everything works fine, you should get some sort of output like this provided there is mail in your mailbox:<br /><br /><div class="codeheader">Code:</div><div class="code">2 messages for dgivens4 at pop.central.cox.net &#40;14886 octets&#41;.<br />reading message dgivens4@pop.central.cox.net&#58;1 of 2 &#40;3052 octets&#41; .. not flushed<br />reading message dgivens4@pop.central.cox.net&#58;2 of 2 &#40;11834 octets&#41; ........... not flushed</div><br />Okay, so the mail has been retrieved to our mailspool. For those of us using mbox type mailboxes, you can check the mail in your spool by run something like:<br /><br /><div class="codeheader">Code:</div><div class="code">cat /var/spool/mail/daniel</div><br />or<br /><div class="codeheader">Code:</div><div class="code">tail /var/spool/mail/daniel</div><br />or<br /><div class="codeheader">Code:</div><div class="code">less /var/spool/mail/daniel</div><br />The first will output the contents of your mailspool to the terminal, tail will show you the last few lines of the file (handy for checking the end of the file where the new messages go) and the last one, everyone should know. You can also skip ahead and setup your IMAPD and MUA to check the mail with a standard mail client. <br /><br />Once fetchmail is configured to your liking and retrieving mail, you can setup a cronjob to retrieve your mail periodically. With my cron daemon, I edit my user's crontab with the following:<br /><br /><div class="codeheader">Code:</div><div class="code">crontab -e</div><br />This edits the crontab for the current user and executes what you tell it to as that user. This is good since we want fetchmail to use the .fetchmailrc in our home directory.<br /><br />Here is what you will need to enter in your crontab. If you want to run fetchmail at a large interval than once a minute, read the manpage on crontab.<br /><br /><div class="codeheader">Code:</div><div class="code">* * * * * fetchmail -aK 1&gt; /dev/null</div><br />The redirection is so we don't get an email every time the crontab is processed. Cron tends to be very verbose unless you tell it not to. <br /><br />Once you have your crontab updated, you may need to tell crond to reread the crontabs. You can do this with the following run as root:<br /><br /><div class="codeheader">Code:</div><div class="code"># echo daniel &gt; /var/spool/cron/crontabs/cron.update</div><br />What we are doing here is putting the name of the user's crontab, conveniently named after the user, that has been updated into the file cron.update. Crond checks for the existence of this file every minute and if it exists rereads the crontab. I am using dcron, so your cron daemon may be different. If these steps don't work, refer to your cron daemon's documentation.<br /><br />In the next part, we will setup Squirrelmail and our MUA so we can retrieve this mail.</div>
					<br />
					<hr size="2" width="100%" />
					Title: <b>Fetchmail and You Part 2</b><br />
					Post by: <b>rugmonster</b> on <b>July 06, 2003, 03:21:23 pm</b>
					<hr />
					<div style="margin: 0 5ex;">I had to split this up due to the db server timing out with such a long post, but here is the rest.<br /><br /><span style="text-decoration: underline;">Preparing for SquirrelMail</span><br /><br />Now we know what we need to get the mail from our ISP's server to our local box and get it delivered to our user's mailbox. We now need to figure out what we need to retrieve those messages. Since we want to use Squirrelmail, we need to look at what it requires to run.<br /><br />First off, we know we are going to need a webserver and since it is written in PHP4 (http://www.php.org), the webserver needs to be PHP4 aware. Apache (http://httpd.apache.org) seems to be a good option, don't you think? Once again, Slackware is so good as to installing Apache 1.3.27 and PHP 4.3.1. I won't go over how to setup Apache and PHP as there are many great guides out there and chances are, you have packages available with your distribution.<br /><br />Second, Squirrelmail prefers an IMAP server to work with. You can use a POP3 server, but the way IMAP works with the folders, it works much better for keeping track of your messages between multiple clients. I like University of Washington's IMAP server, uw-imapd (http://www.washington.edu/imap). It is pretty much plug-and-play; no configurations required! <br /><br />On my system, I had imapd already installed. Your daemon might be different, but I did the following to check:<br /><br /><div class="codeheader">Code:</div><div class="code">#imapd<br />* OK &#91;CAPABILITY IMAP4REV1 LOGIN-REFERRALS STARTTLS AUTH=LOGIN&#93; ender.jasper.homeunix.net IMAP4rev1 2002.336 at Fri, 27 Jun 2003 09&#58;47&#58;31 -0500 &#40;CDT&#41;</div><br />Hit ctrl-c to stop this process.<br /><br />&nbsp;Notice I did that as root because you probably won't be able to run it as a normal user (remember what the /sbin directory is for?).<br /><br />You may need to edit your Internet Super Server's (inetd or xinetd) &nbsp;configuration file and add an entry for your imapd. If you are using inetd, your configuration is probably in /etc/inetd.conf. Add the following line to that file if it isn't already there:<br /><br /><div class="codeheader">Code:</div><div class="code"># Internet Message Access Protocol &#40;IMAP&#41; server&#58;<br />imap4 &nbsp; stream &nbsp;tcp &nbsp; &nbsp; nowait &nbsp;root &nbsp; &nbsp;/usr/sbin/tcpd &nbsp;imapd</div><br />There is a good chance that the entry is there and you could uncomment it. Since I don't run xinetd on my Slackware system, I don't know what exactly you need to do to add it. I know the scripts for xinetd are usually held in /etc/xinetd.d/.<br /><br />If you are running inetd, you need to restart the daemon after editing the configuration file<br /><br /><div class="codeheader">Code:</div><div class="code">#killall -HUP inetd</div><br />Now you should have a working IMAP server.<br /><br /><br /><span style="text-decoration: underline;">Apache and PHP</span><br /><br />I'm not telling you how to do it. Figure it out on your own.<br /><br />I'm just kidding. You need Apache (http://httpd.apache.org) and at least mod_php (http://www.php.net/) to be installed for Squirrelmail to work. If you want SSL, then you need to have OpenSSL (http://www.openssl.org) and mod_ssl (http://www.modssl.org/). I highly recommend using SSL with your webmail, because you don't want employers or coworkers being able to read your personal mail...at least I don't.<br /><br />Chances are, your distribution has a binary release for all of these. If not, then you need another distribution and you need to read the very good howto at http://www.devshed.com/Server_Side/PHP/SoothinglySeamless/page1.html. By the way, that guide will also get you setup with MySQL. Note that it is somewhat dated, but should get the job done.<br /><br /><br /><span style="text-decoration: underline;">Installing Squirrelmail</span><br /><br />The final piece in this puzzle of wonders is Squirrelmail (http://www.squirrelmail.org). Whether you download from their site or install it from a package, the configuration should be the same. There is this really cool configuration script that makes setup very easy.<br /><br />If you get the package from the squirrelmail site, you will ned to untar it in your webroot and configure it. Otherwise, you will need to find where the package put it (probably in your webroot) and find the configuration script.<br /><br /><div class="codeheader">Code:</div><div class="code">#cd &lt;path to webroot&gt;<br />#tar -xzvf &lt;path to source taball&gt;<br />#cd squirrelmail<br />#./configure</div><br />Obviously, if you installed from a package, you don't need the tar line and you can go directly where squirrelmail is installed. When you run the configure script you will get something like this:<br /><br /><div class="codeheader">Code:</div><div class="code">SquirrelMail Configuration &#58; Read&#58; config.php &#40;1.4.0&#41;<br />---------------------------------------------------------<br />Main Menu --<br />1. &nbsp;Organization Preferences<br />2. &nbsp;Server Settings<br />3. &nbsp;Folder Defaults<br />4. &nbsp;General Options<br />5. &nbsp;Themes<br />6. &nbsp;Address Books &#40;LDAP&#41;<br />7. &nbsp;Message of the Day &#40;MOTD&#41;<br />8. &nbsp;Plugins<br />9. &nbsp;Database<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />D. &nbsp;Set pre-defined settings for specific IMAP servers<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />C. &nbsp;Turn color on<br />S &nbsp; Save data<br />Q &nbsp; Quit<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Command &gt;&gt;</div><br />You need to go through the menus and give it your mail server settings and preferences. Once this is done, squirrelmail is setup. You should be able to access it by going to http://localhost/squirrelmail.<br /><br /><span style="text-decoration: underline;">Local MUA Setup</span><br /><br />Since we are now using fetchmail to pull our mail to the local mailspool, we no longer need to use the ISP's mail server. You need to change your mail client on your system to use the local imap server, but still use the ISP's smtp server. Make sure that you set the server type to IMAP and set the address to &quot;localhost&quot;. <br /><br /><br /><span style="text-decoration: underline;">Conclusion</span><br /><br />We did quite a bit, now didn't we? We setup Fetchmail, IMAPD, Apache, modphp and Squirrelmail and learned a little about the way email flows on the internet. There is more you can do with this setup. The next thing I plan on implementing is procmail. For some reason, the amount of spam I receive daily has tripled, so I will be setting up some filters. I plan on writing another article on that. Also, look for an article on setting up ssmtp and a central mailhub. Get rid of all those darn sendmail and postfix daemons!</div>
					<br />
					<hr size="2" width="100%" />
					Title: <b>Fetchmail and You</b><br />
					Post by: <b></b> on <b>July 06, 2003, 09:43:57 pm</b>
					<hr />
					<div style="margin: 0 5ex;">just a quick and dirty (yeah some of the stuff is slightly outdated, but should work non the less) <br />http://www.lancerochelle.com/modules.php?name=Content&amp;pa=showpage&amp;pid=3<br /><br /><br />Yes that's all supposed to be on one line, it does <br /><br />anyway if you have any questions let me know it's one of the things i try to be pretty good at..<br /><br />/lance<br /><br />In addition to all the mail stuff (i use exclusivly squirrelmail (at the moment i am running 1.4.0 with logs of addons)</div>
					<br />
					<hr size="2" width="100%" />
					Title: <b>Fetchmail and You</b><br />
					Post by: <b>rugmonster</b> on <b>July 06, 2003, 10:06:30 pm</b>
					<hr />
					<div style="margin: 0 5ex;">Thanks Lance!</div>
					<br />
					<hr size="2" width="100%" />
					Title: <b>Fetchmail and You</b><br />
					Post by: <b></b> on <b>July 06, 2003, 10:19:38 pm</b>
					<hr />
					<div style="margin: 0 5ex;">OK So there are different schools of thought on whether to use loadable modules or not 2.0.? doesn't offer the built in modules IIRC. but 1.3.? does and i prefer to build it in, only cause i run several different version for testing. &nbsp;I prefer loadable modules in ther kernel, but for some reason i find that apache runs faster when all the modules are compiled in, mind you it takes about 3mb per process if you don't compile them in, and the way i have mine setup is about 12mb per process so i suppose that would be the trade off. &nbsp;Other then that have fun with it.</div>
					<br /><br />
					<div align="center" class="smalltext">
		<span class="smalltext" style="display: inline; visibility: visible; font-family: Verdana, Arial, sans-serif;"><a href="http://www.simplemachines.org/" title="Simple Machines Forum" target="_blank">Powered by SMF 1.1.13</a> |
<a href="http://www.simplemachines.org/about/copyright.php" title="Free Forum Software" target="_blank">SMF &copy; 2006-2011, Simple Machines LLC</a>
		</span></div>
				</td>
			</tr>
		</table>
	</body>
</html>